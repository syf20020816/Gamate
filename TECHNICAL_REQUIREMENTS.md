# Game Partner Skill - 技术需求文档 (TRD)

**版本**: v1.0  
**日期**: 2026-01-28  
**项目周期**: 30 天 MVP  
**负责人**: Rust/React-TS 开发者

---

## 1. 项目概述

### 1.1 产品定位
一款桌面端智能游戏伴侣应用，通过计算机视觉、本地知识库和 AI 对话技术，为玩家提供实时游戏提示、情感陪伴和沉浸式互动体验。

### 1.2 核心价值
- **实时感知**: 自动识别游戏画面，无需手动输入
- **本地优先**: Wiki 数据本地存储，隐私安全且响应快速
- **智能提示**: 基于 RAG 的上下文相关建议
- **情感陪伴**: 语音鼓励、弹幕互动，提升游戏乐趣

### 1.3 目标用户
- 单机游戏玩家（如《艾尔登法环》《博德之门3》）
- 需要攻略帮助但不想频繁切屏的玩家
- 希望获得"有人陪玩"氛围的独游玩家

---

## 2. 功能需求

### 2.1 核心功能 (MVP 必需)

#### F1: 游戏画面识别
- **输入**: 自动全屏/指定窗口截屏 (30 fps)
- **处理**: 
  - 模板匹配识别游戏 UI 元素 (血条、地图、任务栏)
  - OCR 提取关键文本 (任务名、地点、NPC 对话)
- **输出**: 结构化游戏状态数据
- **性能要求**: 
  - 截屏延迟 < 50ms
  - OCR 处理延迟 < 200ms
  - CPU 占用 < 15%

#### F2: Wiki 知识库构建
- **数据源**: 
  - 爬取目标: Fandom Wiki, GameFAQs, IGN Wiki
  - 支持游戏: 初期支持 2-3 款热门单机游戏
- **处理流程**:
  ```
  爬取 HTML → 清洗/分段 → 生成 Embedding → 存入向量库
  ```
- **存储方案**:
  - 向量数据库: Qdrant (本地嵌入式模式)
  - 元数据: SQLite
  - 嵌入模型: all-MiniLM-L6-v2 (快速+小体积)
- **数据规模**: 
  - 单游戏 ~5000 条目
  - 向量维度: 384
  - 总存储: < 500 MB/游戏

#### F3: 实时 AI 提示
- **触发条件**:
  - 检测到新任务/Boss/地点关键词
  - 用户主动呼叫 (快捷键/语音唤醒)
- **RAG 流程**:
  ```
  游戏状态 → 向量检索 (Top-K=5) → LLM 生成提示 → 展示/播报
  ```
- **LLM 选择**:
  - 方案 A (云端): OpenAI GPT-4o-mini (快速+便宜)
  - 方案 B (本地): Llama 3.2 3B (隐私优先)
- **输出形式**:
  - 文字弹窗 (可拖动、半透明)
  - 语音播报 (TTS)
  - 日志记录

#### F4: 语音交互
- **TTS (文字转语音)**:
  - Windows: SAPI 5 (系统自带)
  - 可选: Azure TTS (高质量声音)
  - 音色: 可自定义 (甜美/御姐/少年)
- **语音唤醒 (可选)**:
  - 使用 Vosk (离线语音识别)
  - 唤醒词: "小助手" / "Partner"
- **性能**: TTS 延迟 < 300ms

#### F5: UI 互动层
- **弹幕系统**:
  - 模拟 B 站弹幕效果
  - 内容: AI 生成的鼓励/吐槽/提示
  - 触发: 检测到死亡/胜利/发现新区域
- **送礼动画** (可选):
  - 预设礼物: 火箭/鲜花/666
  - 触发: 完成成就/Boss 战胜利
- **状态展示**:
  - 识别到的游戏名称
  - 当前任务/位置
  - AI 伴侣状态 (思考中/空闲)

### 2.2 辅助功能 (Nice to Have)

- **游戏库管理**: 用户手动添加游戏 + Wiki URL
- **记忆系统**: 记录玩家游戏历史、偏好
- **多语言**: 支持中/英文 Wiki 和界面
- **云同步** (后期): 跨设备同步游戏进度

---

## 3. 技术架构

### 3.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    Tauri 应用层                          │
├──────────────────┬──────────────────────────────────────┤
│   前端 (React)    │         后端 (Rust)                  │
├──────────────────┼──────────────────────────────────────┤
│ • UI 组件         │ • 截屏模块 (screenpipe)               │
│ • 状态管理        │ • OCR 引擎 (tesseract-rs)            │
│ • WebSocket 通信  │ • 向量库 (qdrant-client)             │
│ • 弹幕/礼物动画   │ • LLM 调用 (reqwest)                 │
│                  │ • TTS 引擎 (tts-rs)                   │
│                  │ • 爬虫模块 (scraper)                  │
└──────────────────┴──────────────────────────────────────┘
           ↓                           ↓
    ┌─────────────┐          ┌──────────────────┐
    │  Tauri IPC  │          │  本地数据存储     │
    └─────────────┘          ├──────────────────┤
                             │ • Qdrant (向量)  │
                             │ • SQLite (元数据)│
                             │ • Files (缓存)   │
                             └──────────────────┘
```

### 3.2 核心技术选型

#### 3.2.1 应用框架
- **Tauri 2.0**: 
  - 优势: 小体积 (< 10 MB)、原生性能、安全性
  - IPC 通信: 前后端通过 `invoke` 调用

#### 3.2.2 截屏方案
```toml
# Cargo.toml
screenshots = "0.6"          # 跨平台截屏
windows-capture = "1.0"      # Windows 优化
```
- **实现**: 后台定时器 (33ms/次) → 截屏 → 缓存最新帧
- **优化**: 仅在游戏窗口激活时截屏

#### 3.2.3 OCR 引擎
```toml
tesseract-rs = "0.1"         # 主力 OCR
opencv = "0.88"              # 图像预处理
```
- **流程**: 
  ```rust
  截图 → 灰度化/二值化 → 裁剪 UI 区域 → Tesseract 识别 → 正则提取
  ```
- **语言包**: 中文 (chi_sim) + 英文 (eng)

#### 3.2.4 向量数据库
```toml
qdrant-client = "1.7"
fastembed = "0.3"            # 本地嵌入模型
```
- **部署**: Qdrant 嵌入式模式 (无需独立服务)
- **集合结构**:
  ```rust
  struct WikiEntry {
      id: String,
      game: String,
      title: String,
      content: String,
      embedding: Vec<f32>,  // 384 维
      metadata: HashMap,
  }
  ```

#### 3.2.5 LLM 集成
- **API 调用**:
  ```rust
  // reqwest HTTP 客户端
  let response = client
      .post("https://api.openai.com/v1/chat/completions")
      .json(&payload)
      .send()
      .await?;
  ```
- **Prompt 模板**:
  ```
  你是一个游戏助手。当前游戏:{game}
  玩家状态:{状态}
  相关攻略:{检索内容}
  
  请用 20 字内给出简洁提示,并用鼓励的语气。
  ```

#### 3.2.6 TTS 引擎
```toml
tts = "0.26"                 # 跨平台 TTS
```
- **Windows**: 使用 SAPI 5
- **配置**: 语速 1.2x、音量 0.8

#### 3.2.7 前端技术栈
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "typescript": "^5.0.0",
    "zustand": "^4.4.0",        // 状态管理
    "tailwindcss": "^3.3.0",    // 样式
    "framer-motion": "^10.0.0", // 动画
    "@tauri-apps/api": "^2.0.0" // Tauri API
  }
}
```

---

## 4. 数据流设计

### 4.1 启动流程
```
1. 用户启动应用
2. 加载本地配置 (已添加游戏列表)
3. 初始化 Qdrant 向量库
4. 启动截屏线程
5. 等待游戏窗口激活
```

### 4.2 实时识别流程
```
┌─────────────┐
│  截屏 (33ms) │
└──────┬──────┘
       ↓
┌─────────────────┐
│ 图像处理+OCR     │ ← 提取文本
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 关键词匹配       │ ← 检测任务/Boss/地点
└──────┬──────────┘
       ↓
┌─────────────────┐      ┌──────────────┐
│ 向量检索 (Qdrant)│ ←──→ │ Wiki 知识库  │
└──────┬──────────┘      └──────────────┘
       ↓
┌─────────────────┐
│ LLM 生成提示     │
└──────┬──────────┘
       ↓
┌─────────────────┐      ┌──────────────┐
│ UI 展示 + TTS   │ ───→ │ 前端界面     │
└─────────────────┘      └──────────────┘
```

### 4.3 Wiki 构建流程
```
用户输入 Wiki URL
       ↓
┌─────────────────┐
│ 爬虫抓取页面     │ (scraper + reqwest)
└──────┬──────────┘
       ↓
┌─────────────────┐
│ HTML 解析        │ ← 提取标题/段落/表格
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 文本分段         │ ← 按 512 tokens 切分
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 生成 Embedding   │ ← fastembed 本地推理
└──────┬──────────┘
       ↓
┌─────────────────┐
│ 存入 Qdrant      │
└─────────────────┘
```

---

## 5. 性能指标

### 5.1 响应时间
| 模块 | 目标延迟 | 可接受上限 |
|-----|---------|-----------|
| 截屏 | < 50ms | 100ms |
| OCR | < 200ms | 500ms |
| 向量检索 | < 100ms | 300ms |
| LLM 调用 | < 2s | 5s |
| TTS 播报 | < 300ms | 1s |
| **端到端** | **< 3s** | **6s** |

### 5.2 资源占用
- **内存**: < 500 MB (含向量库)
- **CPU**: 
  - 空闲: < 5%
  - 活跃: < 20%
- **磁盘**: 
  - 应用本体: < 50 MB
  - 单游戏数据: < 500 MB

### 5.3 准确率
- OCR 识别率: > 85% (清晰 UI)
- 关键词匹配准确率: > 90%
- RAG 相关性 (用户满意度): > 70%

---

## 6. 安全与隐私

### 6.1 数据隐私
- **本地优先**: 截屏/OCR 结果不上传云端
- **LLM 调用**: 仅发送文本摘要,不含个人信息
- **日志**: 本地加密存储,用户可一键清除

### 6.2 游戏反检测
- **无注入**: 纯屏幕截图,不修改游戏内存
- **无覆盖**: UI 层不使用 DirectX Hook
- **合规性**: 符合单机游戏使用协议

---

## 7. 依赖清单

### 7.1 Rust 依赖 (Cargo.toml)
```toml
[dependencies]
tauri = "2.0"
serde = { version = "1.0", features = ["derive"] }
tokio = { version = "1.35", features = ["full"] }
reqwest = { version = "0.11", features = ["json"] }

# 截屏+图像
screenshots = "0.6"
opencv = { version = "0.88", features = ["clang-runtime"] }
image = "0.24"

# OCR
tesseract-rs = "0.1"

# 向量库
qdrant-client = "1.7"
fastembed = { version = "0.3", features = ["online"] }

# TTS
tts = "0.26"

# 爬虫
scraper = "0.18"
select = "0.6"

# 数据库
sqlx = { version = "0.7", features = ["sqlite", "runtime-tokio"] }

# 工具
anyhow = "1.0"
log = "0.4"
env_logger = "0.11"
```

### 7.2 前端依赖 (package.json)
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "typescript": "^5.3.0",
    "zustand": "^4.4.7",
    "tailwindcss": "^3.4.0",
    "framer-motion": "^10.16.0",
    "@tauri-apps/api": "^2.0.0",
    "react-query": "^3.39.0",
    "lucide-react": "^0.300.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^5.0.0",
    "autoprefixer": "^10.4.0",
    "postcss": "^8.4.0"
  }
}
```

---

## 8. 风险与缓解

| 风险项 | 影响 | 缓解措施 |
|-------|------|---------|
| OCR 识别率低 | 高 | • 多引擎对比 (Tesseract + PaddleOCR)<br>• 添加模板匹配辅助 |
| LLM 调用成本高 | 中 | • 优先使用本地模型<br>• 限制调用频率 (防抖) |
| 截屏性能开销 | 高 | • 仅截取 UI 区域<br>• 自适应帧率 (10-30 fps) |
| Wiki 版权问题 | 中 | • 声明非商业用途<br>• 遵守 robots.txt |
| 30 天时间不足 | 高 | • 严格 MVP 范围<br>• 提前准备技术预研 |

---

## 9. 交付物

### 9.1 MVP 版本 (30 天)
- [x] 可运行的 Tauri 应用 (Windows)
- [x] 支持 1-2 款游戏的 Wiki 库
- [x] 基础截屏+OCR 识别
- [x] RAG 提示生成
- [x] TTS 语音播报
- [x] 简单弹幕 UI

### 9.2 文档
- [x] 技术需求文档 (本文档)
- [x] 开发计划 (DEVELOPMENT_PLAN.md)
- [ ] API 文档
- [ ] 用户手册

### 9.3 代码仓库
- GitHub Repository
- CI/CD 配置 (GitHub Actions)
- 单元测试覆盖率 > 60%

---

## 10. 后续规划 (MVP 后)

### Phase 2 (2-3 个月)
- 支持更多游戏
- 云端知识库同步
- macOS/Linux 支持
- 高级语音交互 (ASR)

### Phase 3 (长期)
- 游戏内事件识别 (CV 模型)
- 社区分享 Wiki 库
- 付费高级音色/模型
- Steam Workshop 集成

---

**文档状态**: ✅ 已完成  
**最后更新**: 2026-01-28  
**审核人**: Rust/React-TS 开发者
