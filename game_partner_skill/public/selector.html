<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é€‰æ‹©æˆªå›¾åŒºåŸŸ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            overflow: hidden;
            cursor: crosshair;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen',
                'Ubuntu', 'Cantarell', 'Fira Sans', 'Droid Sans', 'Helvetica Neue', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }

        #selection {
            position: fixed;
            border: 2px solid #1890ff;
            background: transparent;
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            display: none;
            z-index: 1001;
        }

        #size-label {
            position: fixed;
            background: #1890ff;
            color: white;
            padding: 6px 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            z-index: 1002;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        #instructions {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1003;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .instruction-text {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .key {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
        }

        /* é¼ æ ‡æç¤º */
        #cursor-hint {
            position: fixed;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            pointer-events: none;
            display: none;
            z-index: 1004;
        }
    </style>
</head>
<body>
    <div id="overlay"></div>
    <div id="selection"></div>
    <div id="size-label"></div>
    <div id="instructions">
        <div class="instruction-text">
            ğŸ–±ï¸ æ‹–æ‹½é€‰æ‹©åŒºåŸŸåæ¾å¼€é¼ æ ‡ | 
            <span class="key">å³é”®</span> å–æ¶ˆ
        </div>
    </div>
    <div id="cursor-hint"></div>

    <script>
        const selection = document.getElementById('selection');
        const sizeLabel = document.getElementById('size-label');
        const instructions = document.getElementById('instructions');
        const cursorHint = document.getElementById('cursor-hint');
        
        let startX = null;
        let startY = null;
        let isSelecting = false;
        let currentArea = null;

        console.log('ğŸ¯ Area selector loaded, waiting for __TAURI__...');

        // ç­‰å¾… Tauri API åŠ è½½
        function waitForTauri() {
            return new Promise((resolve) => {
                if (window.__TAURI__) {
                    console.log('âœ… Tauri API ready');
                    resolve();
                } else {
                    console.log('â³ Waiting for Tauri API...');
                    setTimeout(() => waitForTauri().then(resolve), 100);
                }
            });
        }

        // åˆå§‹åŒ–
        waitForTauri().then(async () => {
            console.log('âœ… Selector initialized');
            
            // å¼ºåˆ¶è·å–ç„¦ç‚¹
            document.body.focus();
            window.focus();
            console.log('ğŸ¯ Focus requested on body and window');
            
            // ä½¿ç”¨ Tauri API ç¡®ä¿çª—å£è·å¾—ç„¦ç‚¹
            try {
                const webview = window.__TAURI__.webviewWindow.getCurrentWebviewWindow();
                await webview.setFocus();
                console.log('âœ… Tauri window focus set');
            } catch (err) {
                console.warn('âš ï¸ Failed to set Tauri focus:', err);
            }
        });

        // é¼ æ ‡æŒ‰ä¸‹ - å¼€å§‹é€‰æ‹©
        document.addEventListener('mousedown', (e) => {
            e.preventDefault();
            console.log('ğŸ–±ï¸ Mouse down at:', e.clientX, e.clientY);
            
            startX = e.clientX;
            startY = e.clientY;
            isSelecting = true;
            
            selection.style.display = 'block';
            selection.style.left = startX + 'px';
            selection.style.top = startY + 'px';
            selection.style.width = '0px';
            selection.style.height = '0px';
            
            // éšè—æç¤º
            instructions.style.display = 'none';
        });

        // é¼ æ ‡ç§»åŠ¨ - æ›´æ–°é€‰æ‹©æ¡†
        document.addEventListener('mousemove', (e) => {
            // æ›´æ–°é¼ æ ‡æç¤ºä½ç½®
            cursorHint.style.left = (e.clientX + 15) + 'px';
            cursorHint.style.top = (e.clientY + 15) + 'px';
            
            if (!isSelecting || startX === null || startY === null) {
                return;
            }

            const currentX = e.clientX;
            const currentY = e.clientY;

            // è®¡ç®—é€‰æ‹©æ¡†ä½ç½®å’Œå¤§å°
            const x = Math.min(startX, currentX);
            const y = Math.min(startY, currentY);
            const width = Math.abs(currentX - startX);
            const height = Math.abs(currentY - startY);

            // æ›´æ–°é€‰æ‹©æ¡†
            selection.style.left = x + 'px';
            selection.style.top = y + 'px';
            selection.style.width = width + 'px';
            selection.style.height = height + 'px';

            // æ›´æ–°å°ºå¯¸æ ‡ç­¾
            if (width > 0 || height > 0) {
                sizeLabel.style.display = 'block';
                sizeLabel.textContent = `${width} Ã— ${height}`;
                
                // æ ‡ç­¾ä½ç½®ï¼ˆé¿å…è¶…å‡ºå±å¹•ï¼‰
                const labelX = x + 5;
                const labelY = y > 30 ? y - 30 : y + height + 10;
                
                sizeLabel.style.left = labelX + 'px';
                sizeLabel.style.top = labelY + 'px';
            }

            currentArea = { x, y, width, height };
        });

        // é¼ æ ‡æ¾å¼€ - å®Œæˆé€‰æ‹©
        document.addEventListener('mouseup', async (e) => {
            if (!isSelecting) return;
            
            console.log('ğŸ–±ï¸ Mouse up, currentArea:', currentArea);
            isSelecting = false;

            if (currentArea && currentArea.width > 10 && currentArea.height > 10) {
                // æ‹–æ‹½å®Œæˆè‡ªåŠ¨ç¡®è®¤,å‘é€é€‰æ‹©ç»“æœåˆ° Tauri
                await sendAreaToBackend(currentArea);
            } else if (currentArea && (currentArea.width > 0 || currentArea.height > 0)) {
                // åŒºåŸŸå¤ªå°ï¼Œå–æ¶ˆ
                resetSelection();
                alert('é€‰æ‹©åŒºåŸŸå¤ªå°ï¼ˆæœ€å° 10x10ï¼‰ï¼Œè¯·é‡æ–°é€‰æ‹©æˆ–å³é”®å–æ¶ˆ');
            }
        });

        // å³é”®å–æ¶ˆ
        document.addEventListener('contextmenu', async (e) => {
            e.preventDefault();
            console.log('ğŸ–±ï¸ Right click - cancelling');
            await cancelSelection();
        });

        // é”®ç›˜äº‹ä»¶å·²ç¦ç”¨ - Tauri å…¨å±é€æ˜çª—å£æ— æ³•æ­£ç¡®è·å¾—é”®ç›˜ç„¦ç‚¹
        // ä½¿ç”¨é¼ æ ‡æ‹–æ‹½æ¾å¼€è‡ªåŠ¨ç¡®è®¤,å³é”®å–æ¶ˆ
        // document.addEventListener('keydown', ...)

        // å‘é€åŒºåŸŸåˆ°åç«¯
        async function sendAreaToBackend(area) {
            try {
                console.log('ğŸ“¤ Sending area to backend:', area);
                
                await waitForTauri();
                
                // ä½¿ç”¨ Tauri å‘½ä»¤å‘é€æ•°æ®
                await window.__TAURI__.core.invoke('set_selected_area', { area });
                console.log('âœ… Area sent successfully');
                
                // å…³é—­çª—å£
                const webview = window.__TAURI__.webviewWindow.getCurrentWebviewWindow();
                console.log('ğŸšª Closing window...');
                await webview.close();
            } catch (error) {
                console.error('âŒ Failed to send area:', error);
                alert('å‘é€åŒºåŸŸå¤±è´¥: ' + error.toString());
            }
        }

        // å–æ¶ˆé€‰æ‹©
        async function cancelSelection() {
            try {
                console.log('ğŸ“¤ Sending cancellation...');
                
                await waitForTauri();
                
                await window.__TAURI__.core.invoke('cancel_area_selection');
                console.log('âœ… Cancellation sent');
                
                const webview = window.__TAURI__.webviewWindow.getCurrentWebviewWindow();
                console.log('ğŸšª Closing window...');
                await webview.close();
            } catch (error) {
                console.error('âŒ Failed to cancel:', error);
                alert('å–æ¶ˆå¤±è´¥: ' + error.toString());
            }
        }

        // é‡ç½®é€‰æ‹©
        function resetSelection() {
            console.log('ğŸ”„ Resetting selection');
            selection.style.display = 'none';
            sizeLabel.style.display = 'none';
            instructions.style.display = 'block';
            startX = null;
            startY = null;
            currentArea = null;
        }

        // ç§»é™¤ä¸å¿…è¦çš„è°ƒè¯•ç›‘å¬å™¨
        console.log('ğŸ“ Event listeners registered');
        console.log('â„¹ï¸ ä½¿ç”¨æ–¹æ³•: æ‹–æ‹½é€‰æ‹©åŒºåŸŸåæ¾å¼€é¼ æ ‡è‡ªåŠ¨ç¡®è®¤ï¼Œå³é”®å–æ¶ˆ');
    </script>
</body>
</html>
